# Docker S3 Instance Profile æµ‹è¯• - æœ¬åœ°æ‰“åŒ…æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°
ç”±äº EC2 å®ä¾‹æ— æ³•è®¿é—® Docker Hubï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æ„å»º Docker é•œåƒï¼Œç„¶åä¼ è¾“åˆ° EC2 è¿›è¡Œæµ‹è¯•ã€‚

## ğŸš€ æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1: æœ¬åœ°æ„å»º Docker é•œåƒ

åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šï¼š

```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd /tmp/docker-s3-test

# æ„å»ºå¹¶ä¿å­˜ Docker é•œåƒ
chmod +x build_and_save.sh
./build_and_save.sh
```

è¿™å°†åˆ›å»ºä¸€ä¸ª `s3-test-image.tar` æ–‡ä»¶ã€‚

### æ­¥éª¤ 2: æ‰‹åŠ¨ä¸Šä¼ åˆ° EC2

#### æ–¹æ³• A: ä½¿ç”¨ SCP ä¸Šä¼ 
```bash
# æ›¿æ¢ your-key.pem ä¸ºæ‚¨çš„å®é™…å¯†é’¥æ–‡ä»¶è·¯å¾„
scp -i your-key.pem s3-test-image.tar ec2-user@52.81.92.36:~/
```

#### æ–¹æ³• B: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬
```bash
# å…ˆç¼–è¾‘ upload_to_ec2.shï¼Œä¿®æ”¹ KEY_FILE å˜é‡
chmod +x upload_to_ec2.sh
./upload_to_ec2.sh
```

### æ­¥éª¤ 3: åœ¨ EC2 ä¸ŠåŠ è½½å¹¶æµ‹è¯•

SSH è¿æ¥åˆ° EC2ï¼š
```bash
ssh -i your-key.pem ec2-user@52.81.92.36
```

åœ¨ EC2 ä¸Šæ‰§è¡Œï¼š
```bash
# åŠ è½½ Docker é•œåƒ
sudo docker load -i s3-test-image.tar

# éªŒè¯é•œåƒåŠ è½½
sudo docker images | grep s3-test

# è¿è¡Œæµ‹è¯•ï¼ˆæŒ‚è½½ä¸»æœºçš„ /tmp ç›®å½•åˆ°å®¹å™¨çš„ /host-tmpï¼‰
sudo docker run --rm -v /tmp:/host-tmp s3-test:latest

# æ£€æŸ¥ä¸»æœºä¸Šä¸‹è½½çš„æ–‡ä»¶
ls -la /tmp/download/

# æ¸…ç†
rm -f s3-test-image.tar
```

### æ•…éšœæ’é™¤

å¦‚æœé‡åˆ°æŒ‚è½½é—®é¢˜ï¼Œå¯ä»¥å…ˆæµ‹è¯•æŒ‚è½½æ˜¯å¦æ­£å¸¸ï¼š
```bash
# æµ‹è¯•æŒ‚è½½æ˜¯å¦å·¥ä½œ
sudo docker run --rm -v /tmp:/host-tmp s3-test:latest ls -la /host-tmp

# å¦‚æœæŒ‚è½½å¤±è´¥ï¼Œå¯ä»¥ä¸ä½¿ç”¨æŒ‚è½½è¿è¡Œï¼ˆæ–‡ä»¶ä¼šä¿å­˜åœ¨å®¹å™¨å†…ï¼‰
sudo docker run --rm s3-test:latest
```

å¦‚æœä¸‹è½½æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œè¯·æ£€æŸ¥ï¼š
```bash
# 1. ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„æŒ‚è½½å‚æ•°
sudo docker run --rm -v /tmp:/host-tmp s3-test:latest

# 2. æ£€æŸ¥ä¸»æœº /tmp ç›®å½•æƒé™
ls -la /tmp/

# 3. æ‰‹åŠ¨åˆ›å»º download ç›®å½•å¹¶è®¾ç½®æƒé™
sudo mkdir -p /tmp/download
sudo chmod 755 /tmp/download

# 4. è¿è¡Œåæ£€æŸ¥æ–‡ä»¶
ls -la /tmp/download/
```

## ğŸ“º é¢„æœŸæµ‹è¯•ç»“æœ

æˆåŠŸæ—¶çš„æ˜¾ç¤ºï¼š
```
============================================================
æµ‹è¯• Docker å®¹å™¨ä¸­çš„ Instance Profile è®¿é—® S3
æµ‹è¯•æ—¶é—´: 2025-08-06 13:15:30.123456
============================================================

1. æµ‹è¯• boto3 S3 è®¿é—®...
âœ… Docker å®¹å™¨ä¸­ S3 è®¿é—®æˆåŠŸï¼
   å…±æœ‰ 90 ä¸ªå­˜å‚¨æ¡¶

   å­˜å‚¨æ¡¶åˆ—è¡¨ï¼ˆå‰3ä¸ªï¼‰:
     - ab2webfront
     - ai-customer-service-apiconstructllmbotdocumentsfc4-i1qr5xylunsj
     - ai-customer-service-apiconstructllmbotdocumentsfc4-ww2owsajcmay

2. æµ‹è¯•å…ƒæ•°æ®æœåŠ¡è®¿é—®...
âœ… å…ƒæ•°æ®æœåŠ¡è®¿é—®æˆåŠŸ
âœ… è§’è‰²åç§°: PVRE-SSMOnboardingRole-K4CRSMYV2BU9

3. æµ‹è¯•èº«ä»½ä¿¡æ¯...
âœ… å½“å‰èº«ä»½:
   è´¦æˆ·ID: 994626867605
   ARN: arn:aws-cn:sts::994626867605:assumed-role/PVRE-SSMOnboardingRole-K4CRSMYV2BU9/i-07f41015322e2403c

4. æµ‹è¯• S3 æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½...
   ğŸ“ åˆ›å»ºæµ‹è¯•æ–‡ä»¶: /tmp/docker-test-20250806-131530.txt
   âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œå¤§å°: 156 å­—èŠ‚
   ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ° S3 æ¡¶: share-something-only-from-here
   âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: s3://share-something-only-from-here/docker-test-20250806-131530.txt
   ğŸ“Š ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:
      - å¤§å°: 156 å­—èŠ‚
      - æœ€åä¿®æ”¹: 2025-08-06 13:15:30+00:00
      - ETag: "d41d8cd98f00b204e9800998ecf8427e"
   ğŸ“¥ ä» S3 ä¸‹è½½æ–‡ä»¶åˆ°: /host-tmp/download/downloaded-docker-test-20250806-131530.txt
   âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: 156 å­—èŠ‚
   âœ… æ–‡ä»¶å†…å®¹éªŒè¯æˆåŠŸï¼Œä¸Šä¼ ä¸‹è½½å®Œæ•´
   ğŸ“ ä¿ç•™æµ‹è¯•æ–‡ä»¶...
   âœ… S3 æ–‡ä»¶å·²ä¿ç•™: s3://share-something-only-from-here/docker-test-20250806-131530.txt
   âœ… åŸå§‹æµ‹è¯•æ–‡ä»¶å·²åˆ é™¤: /tmp/docker-test-20250806-131530.txt
   âœ… ä¸‹è½½æ–‡ä»¶å·²ä¿ç•™: /tmp/download/downloaded-docker-test-20250806-131530.txt
   ğŸ“‹ æ–‡ä»¶ä¿ç•™æ€»ç»“:
      - S3 æ–‡ä»¶: s3://share-something-only-from-here/docker-test-20250806-131530.txt
      - æœ¬åœ°æ–‡ä»¶: /tmp/download/downloaded-docker-test-20250806-131530.txt

============================================================
ğŸ‰ Docker å®¹å™¨æµ‹è¯•æˆåŠŸï¼æ–¹æ³•ä¸€åœ¨å®¹å™¨ä¸­ä¹Ÿæ­£å¸¸å·¥ä½œï¼
============================================================
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœé‡åˆ°æƒé™é”™è¯¯ï¼š
```bash
# ç¡®ä¿ ec2-user åœ¨ docker ç»„ä¸­
sudo usermod -a -G docker ec2-user
# é‡æ–°ç™»å½•æˆ–ä½¿ç”¨ sudo
```

### å¦‚æœé‡åˆ°ç½‘ç»œé”™è¯¯ï¼š
- æ£€æŸ¥ EC2 å®‰å…¨ç»„æ˜¯å¦å…è®¸å‡ºç«™æµé‡
- ç¡®è®¤å®ä¾‹å¯ä»¥è®¿é—®å…ƒæ•°æ®æœåŠ¡ (169.254.169.254)

### å¦‚æœ boto3 å¯¼å…¥å¤±è´¥ï¼š
```bash
# åœ¨ EC2 ä¸Šå®‰è£… boto3ï¼ˆå¦‚æœä¹‹å‰å®‰è£…å¤±è´¥ï¼‰
sudo yum install -y python3-pip
pip3 install --user boto3 requests
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

- `Dockerfile`: Docker é•œåƒæ„å»ºæ–‡ä»¶
- `test_docker_s3.py`: Docker å®¹å™¨å†…çš„æµ‹è¯•è„šæœ¬
- `build_and_save.sh`: æœ¬åœ°æ„å»ºå’Œä¿å­˜é•œåƒçš„è„šæœ¬
- `upload_to_ec2.sh`: è‡ªåŠ¨ä¸Šä¼ åˆ° EC2 çš„è„šæœ¬
- `README.md`: æœ¬è¯´æ˜æ–‡ä»¶
- `.dockerignore`: Docker æ„å»ºå¿½ç•¥æ–‡ä»¶

## ğŸ“¥ ä¸‹è½½æ–‡ä»¶è¯´æ˜

- æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨åœ¨ä¸»æœºçš„ `/tmp` ç›®å½•ä¸‹åˆ›å»º `download` å­ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- é€šè¿‡ Docker å·æŒ‚è½½ `-v /tmp:/host-tmp`ï¼Œå®¹å™¨å¯ä»¥è®¿é—®ä¸»æœºçš„ `/tmp` ç›®å½•
- ä» S3 ä¸‹è½½çš„æ–‡ä»¶ä¼šä¿å­˜åˆ°ä¸»æœºçš„ `/tmp/download/` ç›®å½•ä¸­
- ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶ä¿å­˜åœ¨å®¹å™¨å†…çš„ `/tmp` ç›®å½•ï¼Œæµ‹è¯•å®Œæˆåä¼šè‡ªåŠ¨æ¸…ç†
- ä¸‹è½½çš„æ–‡ä»¶ä¼šä¿ç•™åœ¨ä¸»æœºçš„ `/tmp/download/` ç›®å½•ä¸­ï¼Œæ–¹ä¾¿æŸ¥çœ‹æµ‹è¯•ç»“æœ

## ğŸ¯ æµ‹è¯•ç›®æ ‡

è¿™ä¸ªæµ‹è¯•å°†éªŒè¯ï¼š
1. âœ… Docker å®¹å™¨å¯ä»¥ç»§æ‰¿ EC2 çš„ Instance Profile
2. âœ… boto3 åœ¨å®¹å™¨ä¸­è‡ªåŠ¨è·å–å‡­è¯
3. âœ… å®¹å™¨å¯ä»¥è®¿é—®å…ƒæ•°æ®æœåŠ¡
4. âœ… S3 è®¿é—®æƒé™æ­£å¸¸å·¥ä½œ
5. âœ… S3 æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½
6. âœ… æ–‡ä»¶å®Œæ•´æ€§éªŒè¯
7. âœ… æ–¹æ³•ä¸€ï¼ˆç›´æ¥ç»§æ‰¿ï¼‰çš„å¯è¡Œæ€§
